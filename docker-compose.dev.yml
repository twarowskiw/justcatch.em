services:
  backend:
    image: justcatch-backend-dev-sdk
    build:
      context: ./apps/backend
      dockerfile: Dockerfile.dev
      args:
        DEV_IMAGE_BUST: "1"
    working_dir: /src
    command: ["sh","-lc","dotnet --info && dotnet watch --project ./apps/backend/src/JustCatch.Backend/JustCatch.Backend.csproj --urls http://0.0.0.0:8080"]
    volumes:
      - ./:/src:cached
      - backend_nuget:/root/.nuget/packages
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_URLS=http://+:8080
      - DOTNET_USE_POLLING_FILE_WATCHER=1
      - NTP_HOST=${NTP_HOST:-time.google.com}
      - POKEAPI_BASE_URL=${POKEAPI_BASE_URL:-https://pokeapi.co/api/v2}
    labels:
      # Dev-only: expose Swagger UI through Traefik.
      - traefik.enable=true
      - traefik.http.routers.backend-swagger.rule=PathPrefix(`/swagger`)
      - traefik.http.routers.backend-swagger.entrypoints=web
      - traefik.http.routers.backend-swagger.priority=200
      - traefik.http.routers.backend-swagger.service=backend

  frontend:
    image: justcatchem-frontend-dev
    pull_policy: always
    build:
      context: apps/frontend
      dockerfile: Dockerfile
    working_dir: /app
    command: sh -c "npm ci && npm run dev -- --hostname 0.0.0.0 --port 3000"
    depends_on:
      - backend
    volumes:
      - ./apps/frontend:/app:cached
      - frontend_node_modules:/app/node_modules
    environment:
      - NODE_ENV=development
      - INTERNAL_BACKEND_URL=http://backend:8080
      - WATCHPACK_POLLING=true
      - CHOKIDAR_USEPOLLING=true

volumes:
  backend_nuget:
  frontend_node_modules:
